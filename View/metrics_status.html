<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metrics Status and Prometheus Alerts</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Make the page fit into one screen without scroll */
        body, html {
            height: 100%;
            margin: 0;
        }

        .container {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            padding: 20px;
        }

        .section {
            flex: 1;
            overflow-y: auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        h2 {
            margin-top: 20px;
            font-size: 1.25rem;
        }

        .table {
            font-size: 0.85rem;
        }

        /* Making tables compact */
        .table th, .table td {
            padding: 8px;
        }

        .status-table, .alerts-table {
            margin-bottom: 20px;
        }

        /* Adjust for small screen */
        @media (max-width: 768px) {
            .table {
                font-size: 0.75rem;
            }

            .container {
                padding: 10px;
            }
        }

        /* Responsiveness for tables */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Metrics Status and Prometheus Alerts</h1>

        <!-- Section for Application and Service Status -->
        <div class="section status-table">
            {% if status_messages %}
            <h2>Application and Service Status</h2>
            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>CPU Usage</th>
                            <th>Memory Usage</th>
                            <th>Energy Usage</th>
                            <th>CPU Recommendation</th>
                            <th>Memory Recommendation</th>
                            <th>Energy Recommendation</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in status_messages %}
                        <tr>
                            <td>{{ entry.name }}</td>
                            <td>{{ entry.cpu }}%</td>
                            <td>{{ entry.memory }}%</td>
                            <td>{{ entry.energy }} Wh</td>
                            <td>{{ entry.cpu_recommendation }}</td>
                            <td>{{ entry.memory_recommendation }}</td>
                            <td>{{ entry.energy_recommendation }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p>✅ All applications and services are running optimally.</p>
            {% endif %}
        </div>

        <!-- Section for Prometheus Alerts -->
        <div class="section alerts-table">
            {% if alerts %}
            <h2>Active Prometheus Alerts</h2>
            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead>
                        <tr>
                            <th>Alert Name</th>
                            <th>Severity</th>
                            <th>Instance</th>
                            <th>Service Name</th>
                            <th>Description</th>
                            <th>State</th>
                            <th>Source</th>
                            <th>Actions</th> <!-- Added actions column -->
                        </tr>
                    </thead>
                    <tbody>
                        {% for alert in alerts %}
                        <tr>
                            <td>{{ alert.alertname }}</td>
                            <td>{{ alert.severity }}</td>
                            <td>{{ alert.instance }}</td>
                            <td>{{ alert.service }}</td>
                            <td>{{ alert.description }}</td>
                            <td>{{ alert.state }}</td>
                            <td>{{ alert.source }}</td>
                            <td>
                                <!-- Resolve Alert Button -->
                                <button class="btn btn-danger resolve-alert" 
                                    data-alertname="{{ alert.alertname }}" 
                                    data-service="{{ alert.service }}" 
                                    data-source="{{ alert.source }}">
                                    Resolve Alert
                                </button>

                                <button class="btn btn-success scale-up" data-alertname="{{ alert.alertname }}" 
                                data-service="{{ alert.service }}">Scale Up</button>
                
                                <button class="btn btn-warning scale-down" data-alertname="{{ alert.alertname }}" 
                                data-service="{{ alert.service }}">Scale Down</button>
                
                                <button class="btn btn-danger resolve-alert" data-alertname="{{ alert.alertname }}" 
                                data-service="{{ alert.service }}">Balance</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p>✅ No active alerts from Prometheus.</p>
            {% endif %}
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.querySelectorAll(".scale-up").forEach(button => {
            button.addEventListener("click", function() {
                let alertname = this.getAttribute("data-alertname");
                let service = this.getAttribute("data-service");
                
                fetch("/scale_up", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ alertname: alertname, service: service })
                });
            });
        });
    
        document.querySelectorAll(".scale-down").forEach(button => {
            button.addEventListener("click", function() {
                let alertname = this.getAttribute("data-alertname");
                let service = this.getAttribute("data-service");
    
                fetch("/scale_down", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ alertname: alertname, service: service })
                });
            });
        });

        document.querySelectorAll(".resolve-alert").forEach(button => {
        button.addEventListener("click", function() {
            let alertname = this.getAttribute("data-alertname");
            let service = this.getAttribute("data-service");
            let source = this.getAttribute("data-source");

            fetch("/resolve_alert", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ alertname: alertname, service: service, source: source })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`✅ Alert '${alertname}' for service '${service}' resolved successfully!`);
                    location.reload(); // Refresh page to update alerts table
                } else {
                    alert(`❌ Failed to resolve alert '${alertname}': ${data.error}`);
                }
            })
            .catch(error => console.error("Error resolving alert:", error));
        });
    });
    </script>
</body>
</html>
